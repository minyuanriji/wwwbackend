<?php/** * @link:http://www.gdqijianshi.com/ * @copyright: Copyright (c) 2020 广东七件事集团 * 用户行为轨迹接口处理类 * Author: zal * Date: 2020-07-06 * Time: 14:30 */namespace app\plugins\business_card\forms\api;use app\core\ApiCode;use app\logic\CommonLogic;use app\logic\UserLogic;use app\models\BaseModel;use app\models\User;use app\models\UserChildren;use app\plugins\business_card\forms\common\BusinessCardTrackLogCommon;use app\plugins\business_card\forms\common\Common;use app\plugins\business_card\models\BusinessCard;use app\plugins\business_card\models\BusinessCardSetting;use app\plugins\business_card\models\BusinessCardTrackLog;use app\plugins\business_card\models\BusinessCardTrackStat;class BusinessCardTrackLogForm extends BaseModel{    public $page = 1;    public $limit = 10;    private $msg;    public $track_type;    public $track_user_id;    public $remark;    public $model_id;    public $time_type = -1;    public function rules()    {        return [            [['limit'], 'default', 'value' => 10],            [['page', 'limit','track_type','track_user_id','model_id','time_type'], 'integer'],            [['remark','ip'],'string']        ]; // TODO: Change the autogenerated stub    }    /**     * 获取列表     * @return array     */    public function getList()    {        $returnData = $params = [];        $params["track_user_id"] = \Yii::$app->user->identity->id;        $params["page"] = $this->page;        $params["limit"] = $this->limit;        $params["user"] = 1;        $fields = ['id','track_user','user_id','model_id','remark','created_at'];        $list = BusinessCardTrackLog::getData($params,$fields);        $businessCardSetting = BusinessCardSetting::getData(\Yii::$app->mall->id);        foreach ($list["list"] as &$value){            $value["date"] = date("Y-m-d");            $value["time"] = date("H:i");            $value["text"] = "";            $returnData[] = $value;        }        return $this->returnApiResultData(ApiCode::CODE_SUCCESS, "", $returnData);    }    /**     * 创建     * @return array     */    public function save(){        if(empty($this->track_type)){            return $this->returnApiResultData(ApiCode::CODE_FAIL, "缺少参数");        }        $t = \Yii::$app->db->beginTransaction();        try{            $formData = [];            $formData["user_id"] = \Yii::$app->user->identity->id;            $formData["mall_id"] = \Yii::$app->mall->id;            $formData["track_type"] = $this->track_type;            $formData["track_user_id"] = $this->track_user_id;            $formData["model_id"] = $this->model_id;            $formData["remark"] = $this->remark;            $formData["ip"] =  \Yii::$app->userIp;            $result = BusinessCardTrackLog::operateData($formData);            if ($result === false) {                throw new \Exception("添加失败");            }            unset($formData["remark"],$formData["ip"]);            //添加或更新统计数据            $statData = $formData;            $statData["total"] = 1;            //查询条件            $trackStatParams = [                "user_id" => $formData["user_id"],                "track_user_id" => $formData["track_user_id"],                "track_type" => $formData["track_type"],                "is_one" => 1            ];            if($this->model_id > 0){                $trackStatParams["model_id"] = $this->model_id;            }            $trackStat = BusinessCardTrackStat::getData($trackStatParams);            \Yii::error("plugin_business_card_track_stat ".var_export($trackStat,true));            if(!empty($trackStat)){                $statData["id"] = $trackStat["id"];            }            //更新统计数据            $result = BusinessCardTrackStat::operateData($statData);            if ($result === false) {                throw new \Exception("添加失败!");            }            //更新名片浏览数            if($this->track_type == BusinessCardTrackStat::TRACK_TYPE_LOOK_CARD){                $result = BusinessCard::operateData(["id" => $this->model_id,"visitors" => 1]);                if ($result === false) {                    throw new \Exception("更新失败!");                }            }            $t->commit();            return $this->returnApiResultData(ApiCode::CODE_SUCCESS,"成功");        }catch (\Exception $ex){            $t->rollBack();            \Yii::error("BusinessCardTrackLog save error=".CommonLogic::getExceptionMessage($ex));            return $this->returnApiResultData(999,CommonLogic::getExceptionMessage($ex));        }    }    /**     * 轨迹统计     * @return array     */    public function trackStat()    {        $params = $returnData = $data = $statData = [];        $params = Common::selectTimeRange($params,$this->time_type);        $childList = UserLogic::getAllChildIdsList();        $params["user_id"] = $childList;        $params["group_by"] = "track_type";        //$params["return_sum"] = "total";        $fields = ['count(id) as total','track_type'];        $list = BusinessCardTrackLog::getData($params,$fields);        foreach ($list as $value){            $data[$value["track_type"]] = $value;        }        foreach (BusinessCardTrackStat::$trackTypes as $key => $val){            if(!isset($data[$key])){                $total = 0;            }else{                $total = intval($data[$key]["total"]);            }            $statData["total"] = $total;            $statData["name"] = $val;            $returnData["list"][] = $statData;        }        $hotParams = [];        $hotParams["limit"] = $this->limit;        $hotParams["page"] = $this->page;        $hotParams["user_id"] = $childList;        $hotParams["track_type"] = BusinessCardTrackLog::TRACK_TYPE_GOODS;        $returnData["hot_list"] = BusinessCardTrackLogCommon::selectTrackStatHotRank($hotParams);        return $this->returnApiResultData(ApiCode::CODE_SUCCESS, "", $returnData);    }    /**     * 添加轨迹     * @return array     */    public function addTrack(){        return BusinessCardTrackLogCommon::addTrackLog($this->track_user_id,$this->model_id,$this->track_type,$this->remark);    }}